<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªÙ‚ÙŠÙŠÙ… Ø´ÙÙ‡ÙŠ - ÙƒÙŠÙ…ÙŠØ§Ø¡</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal', sans-serif; background: #f5f5f5; margin: 0; padding: 0; min-height: 100vh; display: flex; }
    .sidebar { width: 280px; background: white; box-shadow: 4px 0 20px rgba(0,0,0,0.1); position: fixed; top: 0; bottom: 0; right: 0; z-index: 100; }
    .sidebar-header { background: #D32F2F; color: white; padding: 30px 20px; text-align: center; font-size: 22px; font-weight: 700; }
    .menu-item { display: flex; align-items: center; padding: 18px 30px; color: #555; text-decoration: none; font-size: 18px; transition: all 0.3s; }
    .menu-item:hover { background: #f0f0f0; color: #D32F2F; }
    .main-content { flex: 1; padding: 40px; margin-right: 280px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .title { font-size: 28px; color: #D32F2F; margin-bottom: 30px; }
    button { padding: 18px 36px; font-size: 20px; background: #D32F2F; color: white; border: none; border-radius: 16px; cursor: pointer; margin: 10px; }
    button:hover { background: #b71c1c; }
    #result { margin-top: 40px; font-size: 24px; text-align: center; padding: 30px; border-radius: 16px; min-height: 100px; max-width: 90%; }
    .good { background: #e8f5e9; color: green; border: 2px solid green; }
    .average { background: #fff3e0; color: orange; border: 2px solid orange; }
    .poor { background: #ffebee; color: red; border: 2px solid red; }
    @media (max-width: 768px) { .sidebar { width: 100%; height: auto; position: relative; } .main-content { margin-right: 0; } }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">ğŸ“š ÙƒÙŠÙ…ÙŠØ§Ø¡ ØªÙØ§Ø¹Ù„ÙŠØ©</div>
    <div class="sidebar-menu">
      <a href="admin.html" class="menu-item"><span class="menu-icon">ğŸ‘¨â€ğŸ«</span> Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³</a>
      <a href="student.html" class="menu-item"><span class="menu-icon">ğŸ‘¨â€ğŸ“</span> ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</a>
      <a href="stats.html" class="menu-item"><span class="menu-icon">ğŸ“Š</span> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</a>
    </div>
  </div>

  <div class="main-content">
    <h2 class="title" id="lessonTitle"></h2>
    <p style="font-size:20px;">Ù„Ø®Øµ Ø§Ù„Ø¯Ø±Ø³ Ø¨ØµÙˆØªÙƒ Ø¯Ù„ÙˆÙ‚ØªÙŠ...</p>
    <button onclick="startListening()">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ„Ø®ÙŠØµ</button>
    <button onclick="readReference()">ğŸ”Š Ø§Ø³Ù…Ø¹ Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ</button>
    <div id="result"></div>
  </div>

  <script>
    const lessons = JSON.parse(localStorage.getItem('chemLessons')) || [];
    const index = localStorage.getItem('currentLessonIndex');
    const lesson = lessons[index];
    document.getElementById('lessonTitle').textContent = lesson?.name || 'Ø¯Ø±Ø³ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

    // Ù‚Ø§Ø¦Ù…Ø© stop words Ø¹Ø±Ø¨ÙŠØ© Ø´Ø§Ø¦Ø¹Ø©
    const stopWords = new Set(['Ø§Ù„', 'ÙÙŠ', 'Ù…Ù†', 'Ø¹Ù„Ù‰', 'Ùˆ', 'Ø¥Ù„Ù‰', 'Ø£Ù†', 'Ù‡Ùˆ', 'Ù‡ÙŠ', 'Ù‡Ù…', 'Ù‡Ù†', 'ÙƒØ§Ù†', 'ÙŠÙƒÙˆÙ†', 'Ø£Ùˆ', 'Ù„Ø§', 'Ù…Ø¹', 'Ø¨Ø¹Ø¯', 'Ù‚Ø¨Ù„', 'Ù„Ù€', 'Ø¨Ù€', 'Øª', 'ÙŠ', 'Ù†', 'Ø§', 'Ø©', 'Ø§Øª', 'ÙˆÙ†', 'ÙŠÙ†']);

    // ÙƒÙ„Ù…Ø§Øª ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ© Ù…Ù‡Ù…Ø© (Ø£Ù…Ø«Ù„Ø©ØŒ Ù…Ù…ÙƒÙ† Ø§Ù„Ù…Ø¯Ø±Ø³ ÙŠØ¹Ø¯Ù„Ù‡Ø§)
    const keyChemistryWords = ['Ø£ÙŠÙˆÙ†', 'Ø°Ø±Ø©', 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†', 'Ø¨Ø±ÙˆØªÙˆÙ†', 'Ù†ÙŠÙˆØªØ±ÙˆÙ†', 'ØªØ±Ø§Ø¨Ø·', 'ØªØ³Ø§Ù‡Ù…ÙŠ', 'Ø£ÙŠÙˆÙ†ÙŠ', 'Ù…Ø¹Ø§Ø¯Ù„Ø©', 'ØªÙØ§Ø¹Ù„', 'Ø­Ù…Ø¶', 'Ù‚Ø§Ø¹Ø¯Ø©', 'Ù…Ù„Ø­', 'Ø£ÙƒØ³Ø¯Ø©', 'Ø§Ø®ØªØ²Ø§Ù„', 'Ø¬Ø¯ÙˆÙ„', 'Ø¯ÙˆØ±ÙŠ', 'Ø¹Ù†ØµØ±', 'Ù…Ø±ÙƒØ¨'];

    function cleanText(text) {
      return text.toLowerCase()
        .replace(/[^\u0600-\u06FF\w\s]/g, ' ') // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠÙ…
        .split(' ')
        .filter(word => word.length > 2 && !stopWords.has(word))
        .join(' ');
    }

    function cosineSimilarity(str1, str2) {
      const words1 = cleanText(str1).split(' ');
      const words2 = cleanText(str2).split(' ');

      const allWords = new Set([...words1, ...words2]);
      const vec1 = [];
      const vec2 = [];

      for (let word of allWords) {
        let score1 = words1.filter(w => w === word).length;
        let score2 = words2.filter(w => w === word).length;

        // ÙˆØ²Ù† Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ© Ø§Ù„Ù…Ù‡Ù…Ø©
        if (keyChemistryWords.some(k => word.includes(k))) {
          score1 *= 2;
          score2 *= 2;
        }

        vec1.push(score1);
        vec2.push(score2);
      }

      const dotProduct = vec1.reduce((sum, v, i) => sum + v * vec2[i], 0);
      const mag1 = Math.sqrt(vec1.reduce((sum, v) => sum + v * v, 0));
      const mag2 = Math.sqrt(vec2.reduce((sum, v) => sum + v * v, 0));

      if (mag1 === 0 || mag2 === 0) return 0;
      return Math.round((dotProduct / (mag1 * mag2)) * 100);
    }

    function getGrade(score) {
      if (score >= 80) return { text: 'Ù…Ù…ØªØ§Ø² Ø¬Ø¯Ù‹Ø§ â­â­', class: 'good' };
      if (score >= 65) return { text: 'Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§ ğŸ‘', class: 'good' };
      if (score >= 50) return { text: 'Ø¬ÙŠØ¯ ğŸ‘', class: 'average' };
      if (score >= 30) return { text: 'Ù…Ù‚Ø¨ÙˆÙ„ØŒ ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†', class: 'average' };
      return { text: 'ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© ÙƒØ¨ÙŠØ±Ø© âŒ', class: 'poor' };
    }

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'ar-SA';
    recognition.continuous = false;

    function startListening() {
      document.getElementById('result').innerHTML = '<div style="color:#D32F2F;">ğŸ™ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹... ØªÙƒÙ„Ù… Ø¨ÙˆØ¶ÙˆØ­</div>';
      recognition.start();

      recognition.onresult = (e) => {
        const summary = e.results[0][0].transcript.trim();
        const score = cosineSimilarity(summary, lesson.reference);
        const grade = getGrade(score);

        document.getElementById('result').innerHTML = `
          <strong>ØªÙ„Ø®ÙŠØµÙƒ:</strong><br>"${summary}"<br><br>
          <strong>Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙ‡Ù… ÙˆØ§Ù„ØªÙ„Ø®ÙŠØµ:</strong> ${score}%<br>
          <strong>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong> ${grade.text}
        `;
        document.getElementById('result').className = grade.class;

        // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        lessons[index].scores.push(score);
        localStorage.setItem('chemLessons', JSON.stringify(lessons));
      };

      recognition.onerror = () => {
        document.getElementById('result').innerHTML = '<div style="color:red;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ØŒ Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ Ø£Ùˆ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø§ÙŠÙƒ</div>';
      };
    }

    function readReference() {
      const utter = new SpeechSynthesisUtterance(lesson.reference);
      utter.lang = 'ar-SA';
      utter.rate = 0.9; // Ø£Ø¨Ø·Ø£ Ø´ÙˆÙŠØ© Ø¹Ø´Ø§Ù† ÙŠØ¨Ù‚Ù‰ ÙˆØ§Ø¶Ø­
      speechSynthesis.speak(utter);
    }
  </script>
</body>
</html>
