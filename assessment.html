<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªÙ‚ÙŠÙŠÙ… Ø´ÙÙ‡ÙŠ - ÙƒÙŠÙ…ÙŠØ§Ø¡</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal', sans-serif; background: #f5f5f5; margin: 0; padding: 0; min-height: 100vh; display: flex; }
    .sidebar { width: 280px; background: white; box-shadow: 4px 0 20px rgba(0,0,0,0.1); position: fixed; top: 0; bottom: 0; right: 0; z-index: 100; }
    .sidebar-header { background: #D32F2F; color: white; padding: 30px 20px; text-align: center; font-size: 22px; font-weight: 700; }
    .menu-item { display: flex; align-items: center; padding: 18px 30px; color: #555; text-decoration: none; font-size: 18px; transition: all 0.3s; }
    .menu-item:hover { background: #f0f0f0; color: #D32F2F; }
    .main-content { flex: 1; padding: 40px; margin-right: 280px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .title { font-size: 28px; color: #D32F2F; margin-bottom: 20px; }
    .instructions { font-size: 20px; margin-bottom: 30px; text-align: center; color: #555; }
    button { padding: 16px 32px; font-size: 19px; background: #D32F2F; color: white; border: none; border-radius: 16px; cursor: pointer; margin: 10px; transition: all 0.3s; }
    button:hover { background: #b71c1c; }
    button.stop { background: #f44336; }
    button.stop:hover { background: #d32f2f; }
    button.toggle-ref { background: #555; }
    .reference-box { width: 90%; max-width: 800px; background: white; border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); padding: 20px; margin: 20px 0; font-size: 18px; line-height: 1.8; display: none; }
    .reference-box.show { display: block; }
    #liveTranscript { margin: 20px 0; padding: 20px; background: #f0f0f0; border-radius: 16px; width: 90%; max-width: 800px; min-height: 100px; font-size: 18px; }
    #visualizer { height: 100px; width: 90%; max-width: 800px; display: flex; align-items: flex-end; justify-content: center; background: #eee; border-radius: 16px; padding: 10px; margin: 20px 0; display: none; }
    .bar { width: 6px; background: #D32F2F; margin: 0 2px; border-radius: 4px; transition: height 0.1s; }
    #result { margin-top: 40px; font-size: 24px; text-align: center; padding: 30px; border-radius: 16px; min-height: 100px; max-width: 90%; }
    .good { background: #e8f5e9; color: green; border: 3px solid #4caf50; }
    .average { background: #fff3e0; color: #ff9800; border: 3px solid #ff9800; }
    .poor { background: #ffebee; color: #f44336; border: 3px solid #f44336; }
    @media (max-width: 768px) { .sidebar { width: 100%; height: auto; position: relative; } .main-content { margin-right: 0; padding: 20px; } }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">ğŸ“š ÙƒÙŠÙ…ÙŠØ§Ø¡ ØªÙØ§Ø¹Ù„ÙŠØ©</div>
    <div class="sidebar-menu">
      <a href="admin.html" class="menu-item"><span class="menu-icon">ğŸ‘¨â€ğŸ«</span> Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³</a>
      <a href="student.html" class="menu-item"><span class="menu-icon">ğŸ‘¨â€ğŸ“</span> ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</a>
      <a href="stats.html" class="menu-item"><span class="menu-icon">ğŸ“Š</span> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</a>
    </div>
  </div>

  <div class="main-content">
    <h2 class="title" id="lessonTitle"></h2>
    <p class="instructions">Ø§Ù‚Ø±Ø£ Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØŒ Ø«Ù… Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£" ÙˆØ§ØªÙƒÙ„Ù… Ø¨Ø±Ø§Ø­ØªÙƒØŒ ÙˆÙ„Ù…Ø§ ØªØ®Ù„Øµ Ø§Ø¶ØºØ· "Ø¥ÙŠÙ‚Ø§Ù"</p>

    <button class="toggle-ref" onclick="toggleReference()">ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ</button>
    <button onclick="readReference()">ğŸ”Š Ø§Ø³Ù…Ø¹ Ø§Ù„ØªÙ„Ø®ÙŠØµ</button>

    <div class="reference-box" id="referenceBox">
      <strong>Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ:</strong><br><br>
      <div id="referenceText"></div>
    </div>

    <button onclick="startListening()">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø§Ù„Ø´ÙÙ‡ÙŠ</button>
    <button class="stop" onclick="stopListening()" style="display:none;" id="stopBtn">â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹</button>

    <!-- Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„ØµÙˆØªÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
    <div id="visualizer"></div>

    <div id="liveTranscript">Ø§Ù„ÙƒÙ„Ø§Ù… Ø§Ù„Ù„ÙŠ Ù‚Ù„ØªÙ‡ Ù„Ø­Ø¯ Ø¯Ù„ÙˆÙ‚ØªÙŠ Ù‡ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§...</div>

    <div id="result"></div>
  </div>

  <script>
    const lessons = JSON.parse(localStorage.getItem('chemLessons')) || [];
    const index = localStorage.getItem('currentLessonIndex');
    const lesson = lessons[index];

    document.getElementById('lessonTitle').textContent = lesson?.name || 'Ø¯Ø±Ø³ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    document.getElementById('referenceText').textContent = lesson?.reference || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ„Ø®ÙŠØµ';

    function toggleReference() {
      document.getElementById('referenceBox').classList.toggle('show');
    }

    function readReference() {
      const utter = new SpeechSynthesisUtterance(lesson.reference);
      utter.lang = 'ar-SA';
      utter.rate = 0.9;
      speechSynthesis.speak(utter);
    }

    // Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ (Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    const stopWords = new Set(['Ø§Ù„', 'ÙÙŠ', 'Ù…Ù†', 'Ø¹Ù„Ù‰', 'Ùˆ', 'Ø¥Ù„Ù‰', 'Ø£Ù†', 'Ù‡Ùˆ', 'Ù‡ÙŠ', 'Ù‡Ù…', 'Ù‡Ù†', 'ÙƒØ§Ù†', 'ÙŠÙƒÙˆÙ†', 'Ø£Ùˆ', 'Ù„Ø§', 'Ù…Ø¹', 'Ø¨Ø¹Ø¯', 'Ù‚Ø¨Ù„', 'Ù„Ù€', 'Ø¨Ù€', 'Øª', 'ÙŠ', 'Ù†', 'Ø§', 'Ø©', 'Ø§Øª', 'ÙˆÙ†', 'ÙŠÙ†']);
    const keyChemistryWords = ['Ø£ÙŠÙˆÙ†', 'Ø°Ø±Ø©', 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†', 'Ø¨Ø±ÙˆØªÙˆÙ†', 'Ù†ÙŠÙˆØªØ±ÙˆÙ†', 'ØªØ±Ø§Ø¨Ø·', 'ØªØ³Ø§Ù‡Ù…ÙŠ', 'Ø£ÙŠÙˆÙ†ÙŠ', 'Ù…Ø¹Ø§Ø¯Ù„Ø©', 'ØªÙØ§Ø¹Ù„', 'Ø­Ù…Ø¶', 'Ù‚Ø§Ø¹Ø¯Ø©', 'Ù…Ù„Ø­', 'Ø£ÙƒØ³Ø¯Ø©', 'Ø§Ø®ØªØ²Ø§Ù„', 'Ø¬Ø¯ÙˆÙ„', 'Ø¯ÙˆØ±ÙŠ', 'Ø¹Ù†ØµØ±', 'Ù…Ø±ÙƒØ¨'];

    function cleanText(text) {
      return text.toLowerCase()
        .replace(/[^\u0600-\u06FF\w\s]/g, ' ')
        .split(' ')
        .filter(word => word.length > 2 && !stopWords.has(word))
        .join(' ');
    }

    function cosineSimilarity(str1, str2) {
      const words1 = cleanText(str1).split(' ');
      const words2 = cleanText(str2).split(' ');

      const allWords = new Set([...words1, ...words2]);
      const vec1 = [];
      const vec2 = [];

      for (let word of allWords) {
        let score1 = words1.filter(w => w === word).length;
        let score2 = words2.filter(w => w === word).length;
        if (keyChemistryWords.some(k => word.includes(k))) {
          score1 *= 2;
          score2 *= 2;
        }
        vec1.push(score1);
        vec2.push(score2);
      }

      const dotProduct = vec1.reduce((sum, v, i) => sum + v * vec2[i], 0);
      const mag1 = Math.sqrt(vec1.reduce((sum, v) => sum + v * v, 0));
      const mag2 = Math.sqrt(vec2.reduce((sum, v) => sum + v * v, 0));

      if (mag1 === 0 || mag2 === 0) return 0;
      return Math.round((dotProduct / (mag1 * mag2)) * 100);
    }

    function getGrade(score) {
      if (score >= 80) return { text: 'Ù…Ù…ØªØ§Ø² Ø¬Ø¯Ù‹Ø§ â­â­', class: 'good' };
      if (score >= 65) return { text: 'Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§ ğŸ‘', class: 'good' };
      if (score >= 50) return { text: 'Ø¬ÙŠØ¯ ğŸ‘', class: 'average' };
      if (score >= 30) return { text: 'Ù…Ù‚Ø¨ÙˆÙ„ØŒ ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†', class: 'average' };
      return { text: 'ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© ÙƒØ¨ÙŠØ±Ø© âŒ', class: 'poor' };
    }

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ + Visualizer
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'ar-SA';
    recognition.continuous = true;
    recognition.interimResults = true;

    let finalTranscript = '';
    let audioContext, analyser, dataArray, microphone, animationId;

    async function startListening() {
      finalTranscript = '';
      document.getElementById('liveTranscript').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹... ØªÙƒÙ„Ù… Ø¨Ø±Ø§Ø­ØªÙƒ';
      document.getElementById('result').innerHTML = '';
      document.getElementById('stopBtn').style.display = 'inline-block';
      document.getElementById('visualizer').style.display = 'flex';

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ Visualizer
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioContext.createAnalyser();
      dataArray = new Uint8Array(analyser.frequencyBinCount);

      // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…Ø§ÙŠÙƒ ÙˆØªÙˆØµÙŠÙ„Ù‡
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      microphone = audioContext.createMediaStreamSource(stream);
      microphone.connect(analyser);

      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø§Ø±Ø§Øª
      const visualizer = document.getElementById('visualizer');
      visualizer.innerHTML = '';
      for (let i = 0; i < 40; i++) {
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.height = '5px';
        visualizer.appendChild(bar);
      }

      recognition.start();

      recognition.onresult = (event) => {
        let interim = '';
        finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript + ' ';
          } else {
            interim += event.results[i][0].transcript;
          }
        }

        document.getElementById('liveTranscript').textContent = finalTranscript + interim;
      };

      drawVisualizer();
    }

    function drawVisualizer() {
      animationId = requestAnimationFrame(drawVisualizer);
      analyser.getByteFrequencyData(dataArray);

      const bars = document.querySelectorAll('.bar');
      const step = Math.floor(dataArray.length / bars.length);

      bars.forEach((bar, i) => {
        const value = dataArray[i * step] || 0;
        bar.style.height = `${Math.max(5, value / 3)}px`;
      });
    }

    function stopListening() {
      recognition.stop();
      if (audioContext) audioContext.close();
      if (animationId) cancelAnimationFrame(animationId);
      document.getElementById('stopBtn').style.display = 'none';
      document.getElementById('visualizer').style.display = 'none';

      if (finalTranscript.trim() === '') {
        document.getElementById('result').innerHTML = 'âš ï¸ Ù…ÙÙŠØ´ ÙƒÙ„Ø§Ù… ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ØŒ Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ';
        return;
      }

      const score = cosineSimilarity(finalTranscript, lesson.reference);
      const grade = getGrade(score);

      document.getElementById('result').innerHTML = `
        <strong>ØªÙ„Ø®ÙŠØµÙƒ Ø§Ù„ÙƒØ§Ù…Ù„:</strong><br>"${finalTranscript}"<br><br>
        <strong>Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙ‡Ù…:</strong> ${score}%<br>
        <strong>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong> ${grade.text}
      `;
      document.getElementById('result').className = grade.class;

      lessons[index].scores.push(score);
      localStorage.setItem('chemLessons', JSON.stringify(lessons));
    }
  </script>
</body>
</html>
